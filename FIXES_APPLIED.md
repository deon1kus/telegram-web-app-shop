# Исправления проблемы с черным экраном

## Дата: $(Get-Date -Format "yyyy-MM-dd")

## Проблема
При запуске магазина на Android через Telegram Web App отображался черный экран, приложение не загружалось.

## Исправленные файлы

### 1. `src/hooks/useTelegramUser.ts`
**Проблема:** Ошибка при парсинге данных из sessionStorage, если данные отсутствуют или неверны.

**Исправление:**
- Добавлена полная обработка ошибок с try-catch
- Добавлены проверки на существование данных перед парсингом
- Добавлено логирование ошибок в консоль
- Функция теперь безопасно возвращает `null` вместо падения приложения

**Изменения:**
```typescript
// Было:
const { tgWebAppData } = JSON.parse(
  sessionStorage.getItem("__telegram__initParams") || ""
);

// Стало:
try {
  const initParamsStr = sessionStorage.getItem("__telegram__initParams");
  if (!initParamsStr) {
    return null;
  }
  // ... полная проверка данных
} catch (error) {
  console.error("Error parsing Telegram user data:", error);
  return null;
}
```

### 2. `src/App.tsx`
**Проблема:** 
- Не вызывался `WebApp.ready()` для инициализации Telegram Web App
- Приложение не расширялось на весь экран
- Нет обработки состояния загрузки

**Исправление:**
- Добавлен `useEffect` для инициализации Telegram Web App
- Добавлен вызов `tgApp.ready()` и `tgApp.expand()`
- Добавлено состояние загрузки с индикатором
- Улучшены сообщения об ошибках
- Приложение теперь работает даже вне контекста Telegram (для разработки)

**Изменения:**
```typescript
// Добавлено:
useEffect(() => {
  if (tgApp) {
    tgApp.ready();
    tgApp.expand();
    setIsReady(true);
  } else {
    setIsReady(true);
  }
}, [tgApp]);
```

### 3. `src/framework/api/utils/api-config.ts`
**Проблема:** Ошибки API не логировались, что затрудняло диагностику.

**Исправление:**
- Добавлено подробное логирование ошибок API
- Разделены типы ошибок (ответ сервера, нет ответа, другие)
- Добавлены понятные сообщения на русском языке

**Изменения:**
```typescript
// Добавлено логирование:
if (err.response) {
  console.error('API Error:', err.response.status, err.response.data);
} else if (err.request) {
  console.error('API Request Error:', 'Нет ответа от сервера...');
}
```

## Новые файлы

### 1. `.env.example`
Пример файла с переменными окружения для настройки API URL.

### 2. `src/utils/image-url.ts`
Утилита для безопасного получения URL изображений с обработкой отсутствия `VITE_API_URL`.

### 3. `TROUBLESHOOTING.md`
Подробное руководство по диагностике и решению проблем.

### 4. `QUICK_START.md`
Быстрый старт и инструкции по запуску приложения.

## Рекомендации

1. **Создайте файл `.env`:**
   ```env
   VITE_API_URL=https://your-api-server.com
   ```

2. **Проверьте консоль браузера:**
   - Откройте DevTools (F12)
   - Проверьте вкладку Console на наличие ошибок
   - Проверьте вкладку Network на проблемы с запросами

3. **Убедитесь, что приложение открывается через Telegram:**
   - Приложение должно запускаться через Telegram бота
   - Проверьте настройки Web App URL в BotFather

4. **Проверьте доступность API:**
   - Убедитесь, что бэкенд сервер запущен
   - Проверьте CORS настройки
   - Проверьте, что API отвечает на запросы

## Тестирование

После применения исправлений:

1. ✅ Приложение не падает при отсутствии данных Telegram
2. ✅ Telegram Web App правильно инициализируется
3. ✅ Ошибки API логируются в консоль
4. ✅ Приложение показывает понятные сообщения об ошибках
5. ✅ Приложение работает даже вне контекста Telegram (для разработки)

## Следующие шаги

1. Создайте файл `.env` с правильным `VITE_API_URL`
2. Перезапустите dev сервер
3. Откройте приложение в Telegram
4. Проверьте консоль браузера на наличие ошибок
5. Если проблема сохраняется, следуйте инструкциям в `TROUBLESHOOTING.md`

